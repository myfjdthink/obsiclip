这是一份完整的 **ObsiClip (黑曜剪) 产品需求文档 (PRD)**。

这份文档整合了我们之前讨论的所有核心功能、UI 布局、交互逻辑，并重点补充了**用户自定义 API Key** 的配置逻辑。

---

# 产品需求文档 (PRD): ObsiClip (黑曜剪)

| 文档版本 | 日期 | 修改人 | 备注 |
| --- | --- | --- | --- |
| v1.0 | 2025-12-31 | PM (Gemini) | 初始版本，定义核心 MVP 功能 |

## 1. 产品概述 (Product Overview)

### 1.1 产品简介

**ObsiClip (黑曜剪)** 是一款专为 Obsidian 用户设计的 Chrome 浏览器扩展。它致力于解决从“网页阅读”到“知识库沉淀”的最后一公里问题。通过智能提取网页正文、利用 AI 进行结构化整理/摘要，并通过 Obsidian URI Scheme 一键保存到本地知识库。

### 1.2 核心价值

* **高精度提取**：基于 Readability 算法 + 人工辅助修正，确保内容抓取准确。
* **AI 赋能**：不仅仅是复制粘贴，而是通过 AI 进行降噪、总结、格式化（Markdown）。
* **隐私优先**：用户自带 API Key，插件不设立中间服务器，数据点对点传输。
* **无缝流转**：侧边栏设计，阅读与剪藏同屏进行。

---

## 2. 用户角色与流程 (User Roles & Flow)

### 2.1 目标用户

* Obsidian 重度用户。
* 需要频繁从网页获取素材的研究人员、开发者、学生。
* 对现有“简单剪藏”工具（只复制文字）不满，希望有 AI 预处理能力的用户。

### 2.2 核心路径

1. **配置**：首次安装，输入 AI 服务商的 API Key 和 Base URL。
2. **激活**：浏览网页，点击插件图标，侧边栏滑出，正文被高亮。
3. **确认/调整**：查看提取的原文，必要时手动调整选区。
4. **AI 处理**：点击“AI 智能整理”，预览整理后的 Markdown 笔记。
5. **保存**：选择目标文件夹，点击保存，自动唤起 Obsidian 写入文件。

---

## 3. 功能需求说明 (Functional Requirements)

### 3.1 设置与配置 (Settings)

*由于插件不提供 AI 服务，配置页是使用的前置条件。*

* **入口**：侧边栏顶部“齿轮”图标 或 插件管理页的“选项”。
* **配置项**：
* **LLM Provider**：下拉选择 (OpenAI / Gemini / Claude / DeepSeek / 自定义)。
* **API Key**：加密输入框 (本地存储，不上传)。
* **Base URL**：接口地址 (默认为官方，支持修改以适配代理或 OneAPI)。
* **Model Name**：模型名称 (如 `gpt-4o`, `claude-3-5-sonnet`)。
* **Prompt 预设**：用户可编辑默认的系统提示词（System Prompt）。


* **校验**：提供一个“测试连接”按钮，验证 Key 是否可用。

### 3.2 网页内容提取 (Extraction Engine)

* **自动识别**：
* 插件激活时，自动运行 `Readability.js` 算法。
* **视觉反馈**：在网页 DOM 上覆盖一层`rgba(0, 122, 255, 0.1)` 的蓝色透明遮罩，边缘虚线框定。
* **转换**：利用 `Turndown` 将 HTML 转为 Markdown，填入侧边栏 Tab 1。


* **手动选取模式 (Picker Mode)**：
* 交互：用户点击侧边栏“手动调整”开关。
* **高亮逻辑**：鼠标悬停在 DOM 节点上显示黄色高亮。
* **点击动作**：点击未选中区域 -> 加入选区（变蓝）；点击已选中区域 -> 移除选区。
* **层级微调**：提供悬浮气泡按钮 `[▲ 扩大范围 (Parent)]` 和 `[▼ 缩小范围 (Child)]`。



### 3.3 侧边栏交互 (Side Panel UI)

#### 区域 A：顶部导航

* **标题编辑**：显示提取的网页标题，支持用户手动修改。
* **Tab 切换**：`[原始内容]` (默认) / `[AI 预览]`。

#### 区域 B：Tab 1 - 原始内容

* **内容展示**：Textarea 显示提取到的 Markdown 源码。
* **核心动作**：底部固定按钮 **[ ✨ AI 智能整理 ]**。
* *点击行为*：自动跳转至 Tab 2，并触发 AI 请求。



#### 区域 C：Tab 2 - AI 预览

* **Prompt 设置区**：默认折叠。展开后显示当前使用的 Prompt，支持临时修改。
* *重试机制*：修改 Prompt 后，按钮变为“重新生成”。


* **预览区**：
* **Loading 态**：骨架屏或 Loading Spinner。
* **Streaming 态**：打字机效果流式输出 AI 响应。
* **渲染态**：支持 Markdown 实时渲染（加粗、列表、代码块高亮）。



### 3.4 保存与输出 (Output & Saving)

* **路径配置**：
* **Vault 选择**：(可选，若用户只有一个库可留空) 输入框。
* **文件夹路径**：下拉框 (记录最近使用的 5 个路径) + 手动输入。支持自动补全（如果技术可行）。
* **Tags**：输入框，以逗号分隔。


* **底部主按钮 (Split Button)**：
* **主按钮 [保存到 Obsidian]**：
* 构建 URI：`obsidian://new?vault=xxx&file=path/to/title&content=encoded_text`。
* 触发浏览器打开外部协议。


* **副菜单 (点击三角形)**：
* `保存为 .md 文件` (调用 Chrome 下载 API)。
* `复制 Markdown` (写入剪贴板)。
* `复制 HTML`。





---

## 4. 特殊网站支持 (Phase 2 规划)

*此部分为架构预留，暂不包含在 MVP 核心开发中，但需设计好接口。*

* **适配器架构**：通过 `sites.json` 配置文件匹配域名。
* **知乎 (Zhihu)**：
* 监测 `.ContentItem-actions`。
* 注入“剪藏”按钮。
* 点击后仅提取当前 Answer 的 HTML，不触发全文 Readability。


* **微信公众号**：
* 针对图片懒加载 (`data-src`) 进行特殊处理，确保转 Markdown 时图片链接有效。



---

## 5. 非功能需求 (Non-Functional Requirements)

### 5.1 性能

* 侧边栏打开速度 < 500ms。
* Readability 识别耗时 < 1s。

### 5.2 安全与隐私

* **Zero-Server Architecture**：除了必要的静态资源 CDN，无任何后端业务服务器。
* **API Key 存储**：必须使用 `chrome.storage.local` 存储，禁止明文同步到云端。
* **网络权限**：Manifest 仅申请必要的 `activeTab` 和 `storage` 权限，以及 AI 域名的 `connect` 权限。

### 5.3 兼容性

* 支持 Chrome 110+ (Manifest V3)。
* 支持 Edge, Brave 等 Chromium 内核浏览器。
* 样式隔离：必须使用 Shadow DOM 渲染侧边栏，防止网页 CSS 污染插件 UI。

---

## 6. 数据埋点 (Telemetry - 仅本地日志)

*鉴于隐私定位，不接入 Google Analytics。*

* 插件内部记录简单的 `Error Log`，便于用户在遇到 Bug 时导出日志发给开发者排查（如：提取失败、AI 接口 401 错误）。

---

## 7. 附录：默认 System Prompt 参考

用户未配置时的默认 AI 提示词：

```markdown
你是一个专业的知识管理助手。请处理以下网页内容，输出为 Obsidian 友好的 Markdown 格式：

1. **Frontmatter**：添加 YAML 头，包含 source(原链接), author, tags(自动生成3-5个)。
2. **摘要**：在开头生成 50-100 字的内容摘要，引用块格式。
3. **正文重组**：
   - 去除广告、推广链接和无关废话。
   - 修正错别字，优化排版。
   - 保留所有代码块、核心数据表格。
   - 将小标题层级标准化（H2, H3）。

请直接输出 Markdown 内容，不要包含“好的，这是整理后的内容”等对话前缀。

```